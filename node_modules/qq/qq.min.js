(function(i){typeof define==="function"?define(function(e,n,j){i(e,n,j)}):typeof exports==="object"?i(require,exports,module):i(function(){return Q},QQ={},{})})(function(i,e,n,j){function m(b){return p(b,m)}function p(d,c){return b.when(d,function(a){if(typeof a!=="object"||a===null||a instanceof Date)return a;else{var d,f;for(f in a)Object.prototype.hasOwnProperty.call(a,f)&&function(g,h){d=b.when(d,function(){return b.when(c(h),function(b){a[g]=b})})}(f,a[f]);return b.when(d,function(){return a})}})}
function q(d){return function(c,a,k,f){return b.when(f,function(g){return b.when(c,function(c){return c[d](function(d,c){return b.when(d,function(d){return b.when(c,function(b){return a.call(g,d,b)})})},k)})})}}var b=i("q"),i=Object.prototype.hasOwnProperty,l;for(l in b)i.call(b,l)&&(e[l]=b[l]);var r=Array.isArray=Array.isArray||function(){return Object.prototype.toString.call(o)==="[object Array]"};e.Queue=function(){var d=b.defer(),c=b.defer();return{put:function(a){var c=b.defer();d.resolve({head:a,
tail:c.promise});d.resolve=c.resolve},get:function(){var a=b.get(d.promise,"head");d.promise=b.get(d.promise,"tail");return b.when(a,null,function(a){c.resolve();return b.reject(a)})},closed:c.promise,close:function(a){a={head:b.reject(a)};a.tail=a;d.resolve(a);return c.promise}}};e.join=function(){var d=Array.prototype.slice.call(arguments),c=d.pop(),a,e=b.defer(),f=d.reduce(function(c,h,f){return b.when(c,function(){return b.when(h,function(a){d[f]=a},function(b){a=a||[];a[f]=b;e.reject(b)})})},
j);b.when(f,e.resolve);return b.when(e.promise,function(){return c?c.apply(null,d):d},function(){a=a||[];return b.reject({toString:function(){return"Can't join. "+a.join("; ")},reasons:b.when(f,function(){return a}),stack:a.reduce(function(a,b){return a||b}).stack})})};e.step=function(){return s.call(arguments,function(d,c){return b.when(m(d),function(a){return c.length>1?c.apply(j,a):c(a)})},j)};e.delay=function(d,c){var a=b.defer();setTimeout(a.resolve,d);return typeof c==="undefined"?a.promise:
typeof c==="function"?b.when(a.promise,c):b.when(a.promise,function(){return c})};e.shallow=function(b){return p(b,function(b){return b})};e.deep=m;e.reduceLeft=q("reduce");e.reduceRight=q("reduceRight");e.reduce=function(d,c,a,e){function f(){g.length<2||b.when(c.call(e,g.shift(),g.shift()),function(a){g.push(a);f()},function(a){h.reject({message:"error in reduction",child:a})})}var g=[];arguments.length>2&&g.push(a);var h=b.defer();b.when(b.shallow(UTIL.map(d,function(a){return b.when(a,function(a){g.push(a);
f()})})),function(){h.resolve(g.shift())},function(a){h.reject({child:a})});return h.promise};e.Lazy=function(d,c){var a=d.prototype,k=e.defer();k.resolve(c);var f=Object.create(k.promise),g=function(a){f[a]=function(){var c=Array.prototype.slice.call(arguments);return b.post(k.promise,a,c)}};if(r(d))d.forEach(g);else for(;a!==Object.prototype;)Object.getOwnPropertyNames(a).forEach(function(b){typeof a[b]==="function"&&g(b)}),a=Object.getPrototypeOf(a);return f};var s=Array.prototype.reduce||function(b,
c){var a=0,e=this.length;if(arguments.length==1){do{if(a in this){c=this[a++];break}if(++a>=e)throw new TypeError;}while(1)}for(;a<e;a++)a in this&&(c=b(c,this[a],a));return c}});